on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # 1. Web Manager 빌드 & 테스트
  build-web-manager:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build web-manager
        uses: docker/build-push-action@v5
        with:
          context: ./web-manager
          file: ./web-manager/Dockerfile
          target: base
          push: false
          tags: web-manager:ci
          cache-from: type=gha,scope=web-manager
          cache-to: type=gha,mode=max,scope=web-manager

  test-web-manager:
    runs-on: ubuntu-latest
    needs: build-web-manager
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build web-manager test stage
        uses: docker/build-push-action@v5
        with:
          context: ./web-manager
          file: ./web-manager/Dockerfile
          target: test
          load: true
          tags: web-manager:test
          cache-from: type=gha,scope=web-manager
      
      - name: Run web-manager tests
        run: |
          docker run --rm web-manager:test uv run pytest tests/ -v

  # 2. AI Server 빌드 & 테스트 (CI 전용 Dockerfile 사용!)
  build-ai-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ai-server (CI version)
        uses: docker/build-push-action@v5
        with:
          context: ./ai-server
          file: ./ai-server/Dockerfile.ci
          target: base
          push: false
          tags: ai-server:ci
          cache-from: type=gha,scope=ai-server-ci
          cache-to: type=gha,mode=max,scope=ai-server-ci

  test-ai-server:
    runs-on: ubuntu-latest
    needs: build-ai-server
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ai-server test stage (CI version)
        uses: docker/build-push-action@v5
        with:
          context: ./ai-server
          file: ./ai-server/Dockerfile.ci
          target: test
          load: true
          tags: ai-server:ci-test
          cache-from: type=gha,scope=ai-server-ci
      
      - name: Run ai-server tests (CPU only)
        run: |
          docker run --rm ai-server:ci-test

  # 3. Docker Compose 검증
  compose-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          cat > .env << 'EOFENV'
          AI_SERVER_IMAGE_NAME=ai-server
          AI_SERVER_IMAGE_TAG=test
          WEB_MANAGER_IMAGE_NAME=web-manager
          WEB_MANAGER_IMAGE_TAG=test
          REDIS_IMAGE_NAME=redis
          REDIS_IMAGE_TAG=latest
          PROMETHEUS_IMAGE_TAG=latest
          GRAFANA_IMAGE_TAG=latest
          NODE_EXPORTER_IMAGE_TAG=latest
          NVIDIA_EXPORTER_IMAGE_TAG=latest
          SHARED_SHM_SIZE=2gb
          DISPLAY=:0
          HOST_IP=localhost
          HOST_OS_VERSION=ubuntu
          HOST_TIMEZONE=Asia/Seoul
          PORT_NUM=1
          REDIS_PORT=6379
          PROMETHEUS_PORT=9090
          GRAFANA_PORT=3000
          NODE_EXPORTER_PORT=9440
          NVIDIA_EXPORTER_PORT=9835
          SUPABASE_KEY=test
          SUPABASE_SERVICE_KEY=test
          EOFENV
      
      - name: Validate docker-compose.yml
        run: docker compose config --quiet

  # 4. 결과 확인
  ci-result:
    runs-on: ubuntu-latest
    needs: [build-web-manager, test-web-manager, build-ai-server, test-ai-server, compose-check]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "=========================================="
          echo "CI Results"
          echo "=========================================="
          echo "Web Manager Build:  ${{ needs.build-web-manager.result }}"
          echo "Web Manager Tests:  ${{ needs.test-web-manager.result }}"
          echo "AI Server Build:    ${{ needs.build-ai-server.result }}"
          echo "AI Server Tests:    ${{ needs.test-ai-server.result }}"
          echo "Compose Check:      ${{ needs.compose-check.result }}"
          echo "=========================================="
          
          if [[ "${{ needs.build-web-manager.result }}" != "success" ]] || \
             [[ "${{ needs.test-web-manager.result }}" != "success" ]] || \
             [[ "${{ needs.build-ai-server.result }}" != "success" ]] || \
             [[ "${{ needs.test-ai-server.result }}" != "success" ]] || \
             [[ "${{ needs.compose-check.result }}" != "success" ]]; then
            echo "❌ CI Failed"
            exit 1
          fi
          
          echo "✅ CI Passed!"
          echo ""
          echo "📝 Notes:"
          echo "  - AI Server: Tested with CPU-only Dockerfile.ci"
          echo "  - Web Manager: Full Docker build and tests"
          echo "  - GPU tests: Run locally with ./test-local.sh ai-server"